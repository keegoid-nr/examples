# .NET Lambda with New Relic and Dedicated HTTP Proxy

This project demonstrates how to deploy a .NET 8 Lambda function that is instrumented with New Relic, runs within a private VPC subnet, and routes all its outbound traffic through a dedicated HTTP proxy server running on an EC2 instance.

This setup is common in enterprise environments where outbound traffic must be inspected, logged, or controlled by a central proxy.

## Project Structure

* `template.yaml`: The AWS SAM template that defines all AWS resources, including the VPC, EC2 proxy, and the Lambda function.
* `src/HttpProxy/`: The directory containing the .NET Lambda project.
  * `Function.cs`: The main Lambda handler code.
  * `HttpProxy.csproj`: The .NET project file.

## Before You Deploy

1. **Install AWS SAM CLI**: If you haven't already, [install the AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html).
2. **Install .NET 8**: Ensure you have the [.NET 8 SDK](https://dotnet.microsoft.com/en-us/download/dotnet/8.0) installed.
3. **Configure AWS Credentials**: Set up your AWS credentials for the SAM CLI to use.
4. **Prerequisites**:
   * A newrelic-log-ingestion function installed with an ingest license key.

## How to Deploy

1. **Build the SAM Application**:
   From the project's root directory, run the build command:

    ```bash
    sam build
    ```

2. **Deploy to AWS**:
   Deploy the application using the guided deployment command:

    ```bash
    sam deploy --guided
    ```

The SAM CLI will prompt you for the required parameters (`NRAccountId`, `NRTrustedAccountKey`).

### How it Works

* **Lambda Function**: The Lambda function produces an expected error and attempts to `noticeError` using the agent's api.
* The **New Relic Lambda Extension** is disabled, so it won't intercept the `NR_LAMBDA_MONITORING` payload generated by the agent. As such, it will make its way into CloudWatch Logs.
* The function's CloudWatch log group should be configured with a subscription filter and pattern that sends the payload to the `newrelic-log-ingestion` function.
* The `newrelic-log-ingestion` function should have debug logging enabled to test for failures, potentially due to the .NET agent's payload metadata format version 2. **The log ingestion function expects a version 1 payload.**

### How to Test and Verify

You can check if the log ingestion function is successfully sending the payload by looking at that function's CloudWatch logs.

#### Failed to Decode Payload

With agent logging set to `finest`:

```yaml
NEW_RELIC_LOG_ENABLED: 1 # Agent logs
NEW_RELIC_LOG_CONSOLE: 1 # Send log messages to the console (stdout/CloudWatch)
NEW_RELIC_LOG_LEVEL: finest # info|debug|finest
```

The log ingestion function fails to decode the version 2 payload, though we still get a 202 response from the endpoint.

```log
1757970578317,"START RequestId: 192b7268-5905-4d27-958b-6dbf8db2808e Version: $LATEST"
1757970578318,"[DEBUG] 2025-09-15T21:09:38.318Z 192b7268-5905-4d27-958b-6dbf8db2808e Enabled debug mode"
1757970578319,"[DEBUG] 2025-09-15T21:09:38.319Z 192b7268-5905-4d27-958b-6dbf8db2808e logGroup: /aws/lambda/kmullaney-sam-dotnet8-cloudwatchpipeline, logStream: 2025/09/15/[$LATEST]9e8c906d8f4e446b9e20435959ecf134, timestamp: 2025-09-15 21:09:29.270000"
1757970578319,"[DEBUG] 2025-09-15T21:09:38.319Z 192b7268-5905-4d27-958b-6dbf8db2808e Using selector: EpollSelector"
1757970578366,"[DEBUG] 2025-09-15T21:09:38.366Z 192b7268-5905-4d27-958b-6dbf8db2808e Failed to decode payload"
1757970578366,"[DEBUG] 2025-09-15T21:09:38.366Z 192b7268-5905-4d27-958b-6dbf8db2808e Failed to decode payload"
1757970578366,"[DEBUG] 2025-09-15T21:09:38.366Z 192b7268-5905-4d27-958b-6dbf8db2808e Failed to decode payload"
1757970578424,"[DEBUG] 2025-09-15T21:09:38.424Z 192b7268-5905-4d27-958b-6dbf8db2808e Sending data to New Relic....."
1757970578652,"[INFO] 2025-09-15T21:09:38.652Z 192b7268-5905-4d27-958b-6dbf8db2808e Log entry sent. Response code: 202. url: https://cloud-collector.newrelic.com/aws/lambda/v1"
1757970578732,"[INFO] 2025-09-15T21:09:38.732Z 192b7268-5905-4d27-958b-6dbf8db2808e Log entry sent. Response code: 202. url: https://log-api.newrelic.com/log/v1"
1757970578732,"[DEBUG] 2025-09-15T21:09:38.732Z 192b7268-5905-4d27-958b-6dbf8db2808e Time elapsed to send to New Relic: 307.18ms"
1757970578765,"END RequestId: 192b7268-5905-4d27-958b-6dbf8db2808e"
1757970578765,"REPORT RequestId: 192b7268-5905-4d27-958b-6dbf8db2808e Duration: 447.13 ms Billed Duration: 448 ms Memory Size: 128 MB Max Memory Used: 67 MB "
```
